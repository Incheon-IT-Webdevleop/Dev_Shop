<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.shop.shop.order.OrderMapper">

    <!-- 월별 주문현황 조회 쿼리 -->
    <select id="getOderByMonth" resultType="com.shop.shop.order.OrderDto">
        SELECT
        DATE_FORMAT(orderAt, '%Y-%m') AS 년월,
        COUNT(*) AS 전체주문건수,
        SUM(TotalPrice) AS 전체주문금액,
        COUNT(CASE WHEN ispayed = true THEN 1 END) AS 결제완료건수,
        SUM(CASE WHEN ispayed = true THEN TotalPrice ELSE 0 END) AS 결제완료금액,
        COUNT(CASE WHEN ispayed = false OR ispayed IS NULL THEN 1 END) AS 미결제건수,
        SUM(CASE WHEN ispayed = false OR ispayed IS NULL THEN TotalPrice ELSE 0 END) AS 미결제금액,
        ROUND(
        COUNT(CASE WHEN ispayed = true THEN 1 END) * 100.0 / COUNT(*), 2
        ) AS 결제완료율
        FROM Orders
        GROUP BY DATE_FORMAT(orderAt, '%Y-%m')
        ORDER BY 년월;
    </select>
</mapper>