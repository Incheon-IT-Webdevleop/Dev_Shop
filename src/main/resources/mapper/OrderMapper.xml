<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.shop.shop.order.OrderMapper">

    <!-- 월별 주문현황 조회 쿼리 -->
    <select id="getOderByMonth" resultType="java.util.HashMap">
        SELECT
        DATE_FORMAT(orderAt, '%Y-%m') AS yearMonth,
        COUNT(*) AS totalOrderCount,
        SUM(TotalPrice) AS totalOrderAmount,
        COUNT(CASE WHEN ispayed = true THEN 1 END) AS paidOrderCount,
        SUM(CASE WHEN ispayed = true THEN TotalPrice ELSE 0 END) AS paidOrderAmount,
        COUNT(CASE WHEN ispayed = false OR ispayed IS NULL THEN 1 END) AS unpaidOrderCount,
        SUM(CASE WHEN ispayed = false OR ispayed IS NULL THEN TotalPrice ELSE 0 END) AS unpaidOrderAmount,
        ROUND(
        COUNT(CASE WHEN ispayed = true THEN 1 END) * 100.0 / COUNT(*), 2
        ) AS paymentCompletionRate,
        AVG(TotalPrice) AS averageOrderAmount,
        SUM(quantity) AS totalQuantity,
        MIN(orderAt) AS firstOrderDate,
        MAX(orderAt) AS lastOrderDate
        FROM Orders
        GROUP BY DATE_FORMAT(orderAt, '%Y-%m')
        ORDER BY yearMonth DESC;
    </select>
</mapper>